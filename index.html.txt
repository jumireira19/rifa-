<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Rifa</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 90%;
            margin: 0 auto;
            padding: 1.5rem;
        }
        @media (min-width: 768px) {
            .container {
                max-width: 800px; /* Aumentar um pouco para acomodar mais bilhetes */
            }
        }
        /* Estilo para o bilhete vencedor */
        .winning-ticket {
            background-color: #ef4444; /* Cor de fundo vermelha (red-500 do Tailwind) */
            color: #ffffff; /* Texto branco */
            font-weight: bold;
            border: 2px solid #dc2626; /* Borda vermelha mais escura (red-600 do Tailwind) */
            transform: scale(1.1); /* Um pequeno zoom */
            transition: all 0.2s ease-in-out;
        }
        /* Estilo para bilhetes selecionáveis */
        .selectable-ticket {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #e0f2fe; /* blue-50 */
            color: #1e40af; /* blue-800 */
            text-xs font-semibold mr-2 mb-2 px-2.5 py-0.5 rounded-full;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            min-width: 40px; /* Garante tamanho mínimo */
            height: 24px;
        }
        .selectable-ticket:hover {
            background-color: #bfdbfe; /* blue-100 */
        }
        .selectable-ticket.selected {
            background-color: #2563eb; /* blue-600 */
            color: #ffffff;
            font-weight: bold;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais para Firebase
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false; // Flag para indicar que a autenticação está pronta

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-raffle-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializa Firebase
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);

        // Listener para o estado de autenticação
        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                window.userId = user.uid;
                console.log("Firebase Auth: Usuário autenticado:", window.userId);
            } else {
                console.log("Firebase Auth: Nenhum usuário. Tentando autenticação...");
                try {
                    if (initialAuthToken) {
                        const customUser = await signInWithCustomToken(window.auth, initialAuthToken);
                        window.userId = customUser.user.uid;
                        console.log("Firebase Auth: Autenticado com token personalizado:", window.userId);
                    } else {
                        const anonUser = await signInAnonymously(window.auth);
                        window.userId = anonUser.user.uid;
                        console.log("Firebase Auth: Autenticado anonimamente:", window.userId);
                    }
                } catch (error) {
                    console.error("Firebase Auth: Erro na autenticação:", error);
                    window.userId = null; // Garante que userId é null em caso de falha
                }
            }
            window.isAuthReady = true;
            document.dispatchEvent(new CustomEvent('firebaseAuthReady'));
        });
    </script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>

    <div class="container bg-white p-6 rounded-lg shadow-xl border border-gray-200">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Gerador de Rifa</h1>

        <!-- Exibição do ID do Usuário -->
        <div class="text-center text-gray-600 text-sm mb-4">
            ID do Usuário: <span id="displayUserId" class="font-mono text-gray-800">Carregando...</span>
        </div>

        <!-- Input para o número máximo de bilhetes a serem gerados -->
        <div class="mb-4">
            <label for="maxTicketNumber" class="block text-gray-700 text-sm font-medium mb-2">
                Número máximo de bilhetes disponíveis para seleção (ex: 100):
            </label>
            <input type="number" id="maxTicketNumber" min="1" value="50"
                   class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out">
            <button id="renderSelectableTicketsBtn"
                    class="mt-2 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                Gerar Opções de Bilhetes
            </button>
        </div>

        <!-- Container para bilhetes selecionáveis -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Selecione os Bilhetes para a Rifa:</h2>
            <div id="selectableTicketsContainer" class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-h-[100px] max-h-60 overflow-y-auto flex flex-wrap gap-2">
                <p class="text-gray-500">Gere as opções de bilhetes acima para começar a selecionar.</p>
            </div>
        </div>

        <!-- Botões de Ação -->
        <div class="flex flex-col sm:flex-row justify-between space-y-3 sm:space-y-0 sm:space-x-3 mb-6">
            <button id="confirmSelectionBtn"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                Confirmar Seleção de Bilhetes
            </button>
            <button id="pickWinnerBtn"
                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75"
                    disabled>
                Sortear Vencedor
            </button>
        </div>

        <!-- Área de Mensagens -->
        <div id="messageBox" class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg relative hidden mb-4" role="alert">
            <span class="block sm:inline"></span>
        </div>

        <!-- Seção para Atribuir Nomes -->
        <div id="nameAssignmentSection" class="mb-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Atribuir Nomes aos Compradores:</h2>
            <div id="nameAssignmentInputsContainer" class="bg-gray-50 p-4 rounded-lg border border-gray-200 max-h-60 overflow-y-auto">
                <p class="text-gray-500">Selecione e confirme os bilhetes para atribuir nomes.</p>
            </div>
            <button id="saveNamesBtn"
                    class="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75">
                Salvar Nomes
            </button>
        </div>

        <!-- Seção para Chave Pix -->
        <div id="pixKeySection" class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Chave Pix para Compra:</h2>
            <div class="mb-4">
                <label for="pixKeyInput" class="block text-gray-700 text-sm font-medium mb-2">
                    Insira a Chave Pix:
                </label>
                <textarea id="pixKeyInput" rows="2" placeholder="Ex: seuemail@example.com ou 123.456.789-00"
                          class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out"></textarea>
            </div>
            <button id="savePixKeyBtn"
                    class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-75">
                Salvar Chave Pix
            </button>
            <div id="displayPixKey" class="mt-4 bg-gray-100 p-3 rounded-lg border border-gray-200 text-gray-800 break-words">
                <p class="text-gray-500">Nenhuma chave Pix salva ainda.</p>
            </div>
        </div>

        <!-- Seção de Compartilhamento -->
        <div id="shareSection" class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Compartilhar Rifa:</h2>
            <button id="generateShareLinkBtn"
                    class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-75">
                Gerar Link de Compartilhamento
            </button>
            <div id="shareLinkDisplaySection" class="mt-4 hidden">
                <label for="shareLinkDisplay" class="block text-gray-700 text-sm font-medium mb-2">
                    Link da Rifa Compartilhada:
                </label>
                <input type="text" id="shareLinkDisplay" readonly
                       class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight bg-gray-100 cursor-text">
                <button id="copyShareLinkBtn"
                        class="mt-2 w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                    Copiar Link
                </button>
            </div>
        </div>

        <!-- Exibição dos Bilhetes Confirmados para a Rifa -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Bilhetes na Rifa:</h2>
            <div id="ticketsDisplay" class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-h-[50px] max-h-40 overflow-y-auto flex flex-wrap gap-2">
                <p class="text-gray-500">Nenhum bilhete confirmado para a rifa ainda.</p>
            </div>
        </div>

        <!-- Exibição do Vencedor -->
        <div class="text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-3">Vencedor:</h2>
            <div id="winnerDisplay" class="bg-purple-100 text-purple-800 text-4xl font-extrabold p-6 rounded-lg shadow-inner border border-purple-300">
                <span class="text-gray-400 text-lg">Ainda não sorteado</span>
            </div>
        </div>

        <!-- Botão de Reset -->
        <div class="mt-6 text-center">
            <button id="resetBtn"
                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                Reiniciar
            </button>
        </div>
    </div>

    <script type="module">
        // Import Firebase functions loaded in the global scope
        import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for application state
        let selectableTickets = []; // All clickable tickets (numbers only)
        let selectedTicketsForRaffle = []; // Tickets selected by the user by clicking (numbers only)
        // generatedTickets now stores objects { number: "001", buyer: "Name" }
        let generatedTickets = [];
        let currentWinner = null; // Variable to store the winning ticket (object { number, buyer })
        let pixKey = ''; // New variable to store the Pix key
        let maxTicketNumberSaved = 50; // New variable to store the saved max ticket number
        let isViewingShared = false; // Flag to indicate if currently viewing a shared link
        let currentShareId = null; // Stores the share ID if viewing a shared link

        // References to DOM elements
        const maxTicketNumberInput = document.getElementById('maxTicketNumber');
        const renderSelectableTicketsBtn = document.getElementById('renderSelectableTicketsBtn');
        const selectableTicketsContainer = document.getElementById('selectableTicketsContainer');
        const confirmSelectionBtn = document.getElementById('confirmSelectionBtn');
        const pickWinnerBtn = document.getElementById('pickWinnerBtn');
        const ticketsDisplay = document.getElementById('ticketsDisplay');
        const winnerDisplay = document.getElementById('winnerDisplay');
        const messageBox = document.getElementById('messageBox');
        const resetBtn = document.getElementById('resetBtn');
        const displayUserId = document.getElementById('displayUserId');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const nameAssignmentSection = document.getElementById('nameAssignmentSection');
        const nameAssignmentInputsContainer = document.getElementById('nameAssignmentInputsContainer');
        const saveNamesBtn = document.getElementById('saveNamesBtn');
        const pixKeyInput = document.getElementById('pixKeyInput');
        const savePixKeyBtn = document.getElementById('savePixKeyBtn');
        const displayPixKey = document.getElementById('displayPixKey');
        const generateShareLinkBtn = document.getElementById('generateShareLinkBtn');
        const shareLinkDisplaySection = document.getElementById('shareLinkDisplaySection');
        const shareLinkDisplay = document.getElementById('shareLinkDisplay');
        const copyShareLinkBtn = document.getElementById('copyShareLinkBtn');

        // Firestore paths
        const getPrivateUserDocRef = () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-raffle-app';
            const userId = window.userId; // Use the global userId defined in authentication
            if (!userId) {
                console.error("UserID not available for private document reference.");
                return null;
            }
            return doc(window.db, `artifacts/${appId}/users/${userId}/raffleData`, 'userData');
        };

        const getPublicShareDocRef = (shareId) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-raffle-app';
            return doc(window.db, `artifacts/${appId}/public/raffleShares`, shareId);
        };

        /**
         * Shows or hides the loading overlay.
         * @param {boolean} show - True to show, False to hide.
         */
        function toggleLoading(show) {
            if (show) {
                loadingOverlay.classList.remove('hidden');
            } else {
                loadingOverlay.classList.add('hidden');
            }
        }

        /**
         * Displays a message in the message box.
         * @param {string} message - The message to display.
         * @param {string} type - The message type (e.g., 'success', 'error', 'warning').
         */
        function showMessage(message, type = 'info') {
            messageBox.querySelector('span').textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'border-red-400', 'text-red-700', 'bg-green-100', 'border-green-400', 'text-green-700', 'bg-yellow-100', 'border-yellow-400', 'text-yellow-700');
            messageBox.classList.add('block');

            switch (type) {
                case 'error':
                    messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    break;
                case 'success':
                    messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    break;
                case 'warning':
                case 'info':
                default:
                    messageBox.classList.add('bg-yellow-100', 'border-yellow-400', 'text-yellow-700');
                    break;
            }
            // Hide the message after 5 seconds
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        /**
         * Saves all raffle data (tickets, winner, Pix key, max ticket number) to Firestore.
         * Saves to the private document if not in shared view.
         * @param {boolean} isPublicShare - If true, saves to a public share document.
         * @param {string} shareId - The ID of the public share document.
         */
        async function saveDataToFirestore(isPublicShare = false, shareId = null) {
            if (isViewingShared && !isPublicShare) { // Prevent saving to private from a shared view
                console.warn("Attempted to save private data while viewing a shared link. Operation aborted.");
                return;
            }
            toggleLoading(true);
            try {
                let docRef;
                if (isPublicShare && shareId) {
                    docRef = getPublicShareDocRef(shareId);
                } else {
                    docRef = getPrivateUserDocRef();
                }

                if (docRef) {
                    const dataToSave = {
                        tickets: generatedTickets,
                        winner: currentWinner,
                        pixKey: pixKey,
                        maxTicketNumber: maxTicketNumberSaved
                    };
                    if (isPublicShare) {
                        dataToSave.ownerId = window.userId; // Store owner ID for public shares
                        dataToSave.lastUpdated = new Date();
                    }
                    await setDoc(docRef, dataToSave);
                    console.log(`Dados da rifa salvos no Firestore (${isPublicShare ? 'público' : 'privado'}).`);
                }
            } catch (e) {
                console.error("Erro ao salvar dados da rifa: ", e);
                showMessage("Erro ao salvar dados. Por favor, tente novamente.", "error");
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * Carrega todos os dados da rifa do Firestore e atualiza a UI.
         */
        async function loadDataFromFirestore() {
            toggleLoading(true);
            try {
                const urlParams = new URLSearchParams(window.location.search);
                currentShareId = urlParams.get('shareId');

                let docRef;
                if (currentShareId) {
                    isViewingShared = true;
                    docRef = getPublicShareDocRef(currentShareId);
                    console.log("Carregando dados da rifa compartilhada...");
                } else {
                    isViewingShared = false;
                    docRef = getPrivateUserDocRef();
                    console.log("Carregando dados da rifa privada...");
                }

                if (docRef) {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        generatedTickets = data.tickets || [];
                        currentWinner = data.winner || null;
                        pixKey = data.pixKey || '';
                        maxTicketNumberSaved = data.maxTicketNumber || 50;

                        console.log("Dados da rifa carregados do Firestore:", data);
                        showMessage("Dados da rifa carregados com sucesso!", "success");

                        // Atualiza a UI com os dados carregados
                        displayConfirmedTickets(generatedTickets);
                        if (currentWinner) {
                            winnerDisplay.textContent = `${currentWinner.number} (${currentWinner.buyer || 'Sem nome'})`;
                        } else {
                            winnerDisplay.innerHTML = '<span class="text-gray-400 text-lg">Ainda não sorteado</span>';
                        }

                        pixKeyInput.value = pixKey;
                        displayPixKey.textContent = pixKey || 'Nenhuma chave Pix salva ainda.';
                        maxTicketNumberInput.value = maxTicketNumberSaved;

                        // Renderiza os bilhetes selecionáveis e marca os selecionados
                        renderSelectableTickets(maxTicketNumberSaved); // Usa o número máximo de bilhetes carregado

                        generatedTickets.forEach(ticket => {
                            const ticketEl = selectableTicketsContainer.querySelector(`[data-ticket="${ticket.number}"]`);
                            if (ticketEl) {
                                ticketEl.classList.add('selected');
                                // Desabilita o clique para todos os bilhetes selecionáveis se eles fazem parte da lista confirmada
                                ticketEl.style.pointerEvents = 'none';
                            }
                        });

                        // Ajusta o estado dos botões e secções com base nos dados carregados e no modo de visualização
                        if (isViewingShared) {
                            // No modo de visualização partilhada, desabilita todos os inputs/botões de modificação
                            maxTicketNumberInput.disabled = true;
                            renderSelectableTicketsBtn.disabled = true;
                            confirmSelectionBtn.disabled = true;
                            pickWinnerBtn.disabled = true; // O vencedor só pode ser sorteado pelo proprietário na visualização privada
                            saveNamesBtn.disabled = true;
                            pixKeyInput.disabled = true;
                            savePixKeyBtn.disabled = true;
                            generateShareLinkBtn.disabled = true; // Não é possível gerar novos links de partilha a partir de uma visualização partilhada
                            resetBtn.textContent = 'Voltar para Minha Rifa'; // Altera o texto do botão de reiniciar
                            nameAssignmentSection.classList.remove('hidden'); // Mostra os nomes, mas os inputs estão desabilitados
                            renderNameAssignmentInputs(); // Renderiza os inputs, mas eles estarão desabilitados
                            nameAssignmentInputsContainer.querySelectorAll('input').forEach(input => input.disabled = true); // Desabilita explicitamente os inputs
                            showMessage("Você está visualizando uma rifa compartilhada (somente leitura).", "info");
                        } else {
                            // Lógica de visualização privada (existente)
                            if (generatedTickets.length > 0) {
                                confirmSelectionBtn.disabled = true;
                                renderSelectableTicketsBtn.disabled = true;
                                pickWinnerBtn.disabled = !currentWinner;
                                nameAssignmentSection.classList.remove('hidden');
                                renderNameAssignmentInputs();
                            } else {
                                confirmSelectionBtn.disabled = false;
                                pickWinnerBtn.disabled = true;
                                nameAssignmentSection.classList.add('hidden');
                            }
                            resetBtn.textContent = 'Reiniciar'; // Texto do botão de reiniciar para visualização privada
                            generateShareLinkBtn.disabled = false; // Habilita o botão de partilha na visualização privada
                        }

                    } else {
                        console.log("Nenhum dado de rifa salvo encontrado para esta visualização.");
                        // Se não houver dados, inicializa a UI como se fosse a primeira vez
                        resetLocalStateAndUI();
                    }
                }
            } catch (e) {
                console.error("Erro ao carregar dados da rifa: ", e);
                showMessage("Erro ao carregar dados. Por favor, tente novamente.", "error");
                resetLocalStateAndUI(); // Reinicia a UI em caso de erro de carregamento
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * Exclui todos os dados da rifa salvos do Firestore.
         * Apenas exclui dados privados. Partilhas públicas não são excluídas por isso.
         */
        async function deleteDataFromFirestore() {
            toggleLoading(true);
            try {
                const docRef = getPrivateUserDocRef(); // Sempre exclui dados privados
                if (docRef) {
                    await deleteDoc(docRef);
                    console.log("Dados da rifa excluídos do Firestore (privado).");
                    showMessage("Dados da rifa reiniciados com sucesso!", "success");
                }
            } catch (e) {
                console.error("Erro ao excluir dados da rifa: ", e);
                showMessage("Erro ao reiniciar dados. Por favor, tente novamente.", "error");
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * Renderiza os bilhetes que podem ser selecionados pelo utilizador.
         * @param {number} maxNumber - O número máximo de bilhetes a serem exibidos.
         */
        function renderSelectableTickets(maxNumber) {
            selectableTicketsContainer.innerHTML = ''; // Limpa o container
            selectableTickets = []; // Limpa a lista de bilhetes selecionáveis
            selectedTicketsForRaffle = []; // Limpa os bilhetes selecionados localmente

            if (maxNumber <= 0 || isNaN(maxNumber)) {
                selectableTicketsContainer.innerHTML = '<p class="text-gray-500">Número inválido de bilhetes.</p>';
                return;
            }

            for (let i = 1; i <= maxNumber; i++) {
                const ticketNumber = String(i).padStart(3, '0');
                const ticketSpan = document.createElement('span');
                ticketSpan.textContent = ticketNumber;
                ticketSpan.classList.add('selectable-ticket', 'text-blue-800', 'bg-blue-100', 'text-xs', 'font-semibold', 'mr-2', 'mb-2', 'px-2.5', 'py-0.5', 'rounded-full');
                ticketSpan.dataset.ticket = ticketNumber; // Armazena o número do bilhete no dataset

                ticketSpan.addEventListener('click', () => {
                    // Apenas permite a seleção se os bilhetes ainda não foram confirmados para a rifa
                    if (confirmSelectionBtn.disabled) {
                        showMessage('Os bilhetes já foram confirmados. Reinicie para fazer novas seleções.', 'info');
                        return;
                    }

                    ticketSpan.classList.toggle('selected');
                    if (ticketSpan.classList.contains('selected')) {
                        selectedTicketsForRaffle.push(ticketNumber);
                    } else {
                        selectedTicketsForRaffle = selectedTicketsForRaffle.filter(t => t !== ticketNumber);
                    }
                    // Ordena para manter a consistência visual, mas não é estritamente necessário para a lógica
                    selectedTicketsForRaffle.sort((a, b) => parseInt(a, 10) - parseInt(b, 10));
                });
                selectableTicketsContainer.appendChild(ticketSpan);
                selectableTickets.push(ticketNumber);
            }
            // Não exibe mensagem aqui, pois esta função pode ser chamada durante o carregamento inicial.
            // A mensagem será exibida por loadDataFromFirestore ou pelo clique do botão "Gerar Opções".
        }

        /**
         * Renderiza os campos de entrada para atribuir nomes aos bilhetes selecionados.
         */
        function renderNameAssignmentInputs() {
            nameAssignmentInputsContainer.innerHTML = ''; // Limpa o container
            if (generatedTickets.length === 0) {
                nameAssignmentInputsContainer.innerHTML = '<p class="text-gray-500">Nenhum bilhete para atribuir nomes.</p>';
                return;
            }

            generatedTickets.forEach(ticket => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center', 'mb-2');

                const label = document.createElement('label');
                label.classList.add('text-gray-700', 'text-sm', 'font-medium', 'w-16');
                label.textContent = `Bilhete ${ticket.number}:`;
                div.appendChild(label);

                const input = document.createElement('input');
                input.type = 'text';
                input.classList.add('shadow-sm', 'appearance-none', 'border', 'rounded-lg', 'flex-1', 'py-2', 'px-3', 'text-gray-700', 'leading-tight', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-500', 'focus:border-transparent');
                input.placeholder = 'Nome do comprador';
                input.value = ticket.buyer || ''; // Preenche com o nome existente
                input.dataset.ticketNumber = ticket.number; // Associa o input ao número do bilhete
                div.appendChild(input);

                nameAssignmentInputsContainer.appendChild(div);
            });
        }

        /**
         * Salva os nomes inseridos nos campos de entrada na variável generatedTickets.
         */
        async function saveNames() {
            const nameInputs = nameAssignmentInputsContainer.querySelectorAll('input[type="text"]');
            nameInputs.forEach(input => {
                const ticketNumber = input.dataset.ticketNumber;
                const buyerName = input.value.trim();
                const ticketIndex = generatedTickets.findIndex(t => t.number === ticketNumber);
                if (ticketIndex !== -1) {
                    generatedTickets[ticketIndex].buyer = buyerName;
                }
            });
            await saveDataToFirestore(); // Salva os nomes atualizados no Firestore
            displayConfirmedTickets(generatedTickets); // Atualiza a exibição dos bilhetes
            showMessage('Nomes salvos com sucesso!', "success");
        }

        /**
         * Salva a chave Pix inserida no campo de entrada.
         */
        async function savePixKey() {
            pixKey = pixKeyInput.value.trim();
            displayPixKey.textContent = pixKey || 'Nenhuma chave Pix salva ainda.';
            await saveDataToFirestore(); // Salva a chave Pix atualizada no Firestore
            showMessage('Chave Pix salva com sucesso!', "success");
        }

        /**
         * Exibe os bilhetes que foram confirmados para a rifa na interface, incluindo o nome do comprador.
         * @param {Array<Object>} tickets - O array de objetos de bilhetes a serem exibidos.
         */
        function displayConfirmedTickets(tickets) {
            if (tickets.length === 0) {
                ticketsDisplay.innerHTML = '<p class="text-gray-500">Nenhum bilhete confirmado para a rifa ainda.</p>';
            } else {
                ticketsDisplay.innerHTML = tickets.map(ticket => {
                    const isWinner = (currentWinner && ticket.number === currentWinner.number) ? 'winning-ticket' : '';
                    const buyerInfo = ticket.buyer ? ` (${ticket.buyer})` : '';
                    return `<span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold mr-2 mb-2 px-2.5 py-0.5 rounded-full ${isWinner}">${ticket.number}${buyerInfo}</span>`;
                }).join('');
            }
        }

        /**
         * Seleciona um vencedor aleatoriamente entre os bilhetes gerados (confirmados).
         * @returns {Object | null} - O objeto do bilhete vencedor ({ number, buyer }) ou null se não houver bilhetes.
         */
        function pickWinner() {
            if (generatedTickets.length === 0) {
                showMessage('Por favor, confirme os bilhetes para a rifa primeiro.', "warning");
                return null;
            }
            const randomIndex = Math.floor(Math.random() * generatedTickets.length);
            return generatedTickets[randomIndex];
        }

        /**
         * Limpa o estado local da aplicação e a interface, sem interagir com o Firestore.
         * Usado para inicialização ou após um erro de carregamento.
         */
        function resetLocalStateAndUI() {
            selectableTickets = [];
            selectedTicketsForRaffle = [];
            generatedTickets = [];
            currentWinner = null;
            pixKey = '';
            maxTicketNumberSaved = 50; // Reinicia o número máximo de bilhetes para o padrão
            isViewingShared = false;
            currentShareId = null;

            maxTicketNumberInput.value = maxTicketNumberSaved;
            renderSelectableTickets(maxTicketNumberSaved);

            displayConfirmedTickets([]);
            winnerDisplay.innerHTML = '<span class="text-gray-400 text-lg">Ainda não sorteado</span>';
            nameAssignmentInputsContainer.innerHTML = '<p class="text-gray-500">Selecione e confirme os bilhetes para atribuir nomes.</p>';
            nameAssignmentSection.classList.add('hidden');

            pixKeyInput.value = '';
            displayPixKey.textContent = 'Nenhuma chave Pix salva ainda.';

            // Reabilita todos os inputs e botões para a visualização privada
            maxTicketNumberInput.disabled = false;
            renderSelectableTicketsBtn.disabled = false;
            confirmSelectionBtn.disabled = false;
            pickWinnerBtn.disabled = true;
            saveNamesBtn.disabled = false;
            pixKeyInput.disabled = false;
            savePixKeyBtn.disabled = false;
            generateShareLinkBtn.disabled = false; // Habilita o botão de partilha
            shareLinkDisplaySection.classList.add('hidden'); // Esconde a exibição do link de partilha
            shareLinkDisplay.value = ''; // Limpa o input do link de partilha

            resetBtn.textContent = 'Reiniciar'; // Reinicia o texto do botão para visualização privada

            const selectableTicketElements = selectableTicketsContainer.querySelectorAll('.selectable-ticket');
            selectableTicketElements.forEach(ticketEl => {
                ticketEl.classList.remove('selected');
                ticketEl.style.pointerEvents = 'auto';
            });
            nameAssignmentInputsContainer.querySelectorAll('input').forEach(input => input.disabled = false); // Reabilita os inputs de nome

            messageBox.classList.add('hidden');
            showMessage('Aplicação reiniciada. Gere as opções de bilhetes para começar.', "info");
        }

        /**
         * Reinicia a aplicação. Se estiver a visualizar um link partilhado, navega de volta para a visualização privada.
         * Caso contrário, exclui os dados privados e reinicia localmente.
         */
        async function resetApp() {
            if (isViewingShared) {
                window.location.href = window.location.origin + window.location.pathname; // Navega de volta para a visualização privada
            } else {
                await deleteDataFromFirestore(); // Apenas exclui dados privados
                resetLocalStateAndUI();
            }
        }

        /**
         * Gera um link partilhável para os dados atuais da rifa.
         */
        async function generateShareLink() {
            if (generatedTickets.length === 0) {
                showMessage("Por favor, confirme os bilhetes e nomes antes de gerar um link de compartilhamento.", "warning");
                return;
            }

            toggleLoading(true);
            try {
                const shareId = crypto.randomUUID(); // Gera um ID único para a partilha
                await saveDataToFirestore(true, shareId); // Salva os dados atuais num documento de partilha pública

                const shareUrl = `${window.location.origin}${window.location.pathname}?shareId=${shareId}`;
                shareLinkDisplay.value = shareUrl;
                shareLinkDisplaySection.classList.remove('hidden');
                showMessage("Link de compartilhamento gerado com sucesso!", "success");

            } catch (e) {
                console.error("Erro ao gerar link de compartilhamento:", e);
                showMessage("Erro ao gerar link de compartilhamento. Por favor, tente novamente.", "error");
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * Copia o link de partilha para a área de transferência.
         */
        function copyShareLink() {
            const shareLinkInput = document.getElementById('shareLinkDisplay');
            shareLinkInput.select(); // Seleciona o texto no campo de input
            shareLinkInput.setSelectionRange(0, 99999); // Para dispositivos móveis

            let copiedSuccessfully = false;
            try {
                copiedSuccessfully = document.execCommand('copy');
            } catch (err) {
                console.error('Erro ao tentar copiar o link:', err);
                copiedSuccessfully = false;
            }

            if (copiedSuccessfully) {
                showMessage("Link copiado para a área de transferência!", "success");
                // Opcional: Adiciona um feedback visual temporário ao campo de input
                shareLinkInput.classList.add('border-green-500', 'ring-2', 'ring-green-500');
                setTimeout(() => {
                    shareLinkInput.classList.remove('border-green-500', 'ring-2', 'ring-green-500');
                }, 1500);
            } else {
                // Fallback para casos em que a cópia direta falha
                showMessage("Não foi possível copiar automaticamente. Por favor, selecione o texto no campo acima e copie manualmente (Ctrl+C ou Cmd+C).", "warning");
                // Destaca o campo de input de forma mais proeminente para cópia manual
                shareLinkInput.focus();
                shareLinkInput.classList.add('border-red-500', 'ring-2', 'ring-red-500');
                setTimeout(() => {
                    shareLinkInput.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
                }, 3000);
            }
        }

        // Event Listeners

        // Botão para gerar opções de bilhetes clicáveis
        renderSelectableTicketsBtn.addEventListener('click', async () => {
            const maxNum = parseInt(maxTicketNumberInput.value, 10);
            if (isNaN(maxNum) || maxNum <= 0) {
                showMessage('Por favor, insira um número válido de bilhetes disponíveis (maior que zero).', "error");
                return;
            }
            maxTicketNumberSaved = maxNum; // Atualiza o número máximo de bilhetes guardado
            renderSelectableTickets(maxNum);
            confirmSelectionBtn.disabled = false; // Habilita o botão de confirmar seleção
            pickWinnerBtn.disabled = true; // Desabilita o sorteio enquanto não há bilhetes confirmados
            winnerDisplay.innerHTML = '<span class="text-gray-400 text-lg">Ainda não sorteado</span>'; // Limpa o vencedor
            nameAssignmentSection.classList.add('hidden'); // Esconde a secção de nomes
            shareLinkDisplaySection.classList.add('hidden'); // Esconde a exibição do link de partilha
            shareLinkDisplay.value = ''; // Limpa o input do link de partilha
            showMessage(`Foram geradas ${maxNum} opções de bilhetes. Agora, selecione os que deseja incluir na rifa.`, "info");
            await saveDataToFirestore(); // Salva o número máximo de bilhetes atualizado
        });

        // Botão para confirmar a seleção de bilhetes para a rifa
        confirmSelectionBtn.addEventListener('click', async () => {
            if (selectedTicketsForRaffle.length === 0) {
                showMessage('Por favor, selecione pelo menos um bilhete para a rifa.', "warning");
                return;
            }
            // Converte os números selecionados em objetos de bilhete com nomes vazios
            generatedTickets = selectedTicketsForRaffle.map(number => ({ number: number, buyer: '' }));
            currentWinner = null; // Limpa o vencedor anterior
            displayConfirmedTickets(generatedTickets); // Exibe os bilhetes confirmados
            pickWinnerBtn.disabled = false; // Habilita o botão de sortear
            confirmSelectionBtn.disabled = true; // Desabilita após confirmar
            renderSelectableTicketsBtn.disabled = true; // Desabilita a geração de novas opções

            // Desabilita os cliques nos bilhetes selecionáveis após a confirmação
            const selectableTicketElements = selectableTicketsContainer.querySelectorAll('.selectable-ticket');
            selectableTicketElements.forEach(ticketEl => {
                ticketEl.style.pointerEvents = 'none'; // Desabilita o clique para todos os bilhetes selecionáveis
            });

            nameAssignmentSection.classList.remove('hidden'); // Mostra a secção de nomes
            renderNameAssignmentInputs(); // Renderiza os inputs de nome
            shareLinkDisplaySection.classList.add('hidden'); // Esconde a exibição do link de partilha
            shareLinkDisplay.value = ''; // Limpa o input do link de partilha

            await saveDataToFirestore(); // Salva os bilhetes no Firestore
            showMessage(`${generatedTickets.length} bilhetes foram confirmados para a rifa! Agora, atribua os nomes.`, "success");
        });

        // Botão para salvar nomes
        saveNamesBtn.addEventListener('click', saveNames);

        // Botão para salvar a chave Pix
        savePixKeyBtn.addEventListener('click', savePixKey);

        // Botão para gerar link de partilha
        generateShareLinkBtn.addEventListener('click', generateShareLink);

        // Botão para copiar link de partilha
        copyShareLinkBtn.addEventListener('click', copyShareLink);

        pickWinnerBtn.addEventListener('click', async () => {
            const winner = pickWinner();
            if (winner) {
                currentWinner = winner; // Armazena o vencedor
                winnerDisplay.textContent = `${currentWinner.number} (${currentWinner.buyer || 'Sem nome'})`;
                displayConfirmedTickets(generatedTickets); // Atualiza a exibição para destacar o vencedor
                pickWinnerBtn.disabled = true; // Desabilita após sortear
                await saveDataToFirestore(); // Salva o vencedor no Firestore
                showMessage(`O bilhete vencedor é: ${winner.number} (${winner.buyer || 'Sem nome'})!`, "success");
            }
        });

        resetBtn.addEventListener('click', resetApp);

        // Inicializa a aplicação quando a página carrega
        document.addEventListener('firebaseAuthReady', () => {
            console.log("Evento firebaseAuthReady recebido.");
            if (window.userId) {
                displayUserId.textContent = window.userId; // Exibe o ID do utilizador
                loadDataFromFirestore(); // Carrega todos os dados guardados
            } else {
                displayUserId.textContent = "Falha na Autenticação";
                showMessage("Não foi possível autenticar o usuário. A persistência de dados pode não funcionar.", "error");
                // Procede com um estado de UI limpo se a autenticação falhar
                resetLocalStateAndUI();
            }
        });

        // Garante que a UI é inicializada com um estado padrão enquanto aguarda a autenticação e o carregamento
        window.onload = () => {
            // Renderiza as opções de bilhetes selecionáveis inicialmente com o valor padrão
            renderSelectableTickets(parseInt(maxTicketNumberInput.value, 10));
            // A lógica de carregamento e atualização da UI será tratada pelo 'firebaseAuthReady'
        };
    </script>
</body>
</html>
